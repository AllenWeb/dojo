<!DOCTYPE html>
<html>
	<head>
		<title>Parser scan() Performance Test</title>
		<style type="text/css">     
			@import "../../resources/dojo.css";
		</style>
		<script type="text/javascript" src="../../dojo.js" data-dojo-config="isDebug:true, async:true"></script>
		<script type="text/javascript">
		require([
			"dojo/_base/declare",
			"dojo/dom",
			"dojo/dom-construct",
			"dojo/_base/lang",
			"dojo/parser",
			"doh",
			"dojo/domReady!"
		], function(declare, dom, domConstruct, lang, parser, doh){

			var mixin = lang.mixin,
				extend = lang.extend,
				exists = lang.exists;

			declare("TabContainer", null, {
				numberProp1: 1,
				numberProp2: 2,
				booleanProp1: false,
				booleanProp2: true,
				strProp1: "original1",
				strProp2: "original2",
				funcProp: function(){}
			});
			declare("ContentPane", null, {
				stopParser: true,
				numberProp1: 1,
				numberProp2: 2,
				booleanProp1: false,
				booleanProp2: true,
				strProp1: "original1",
				strProp2: "original2",
				funcProp: function(){}
			});
			declare("TextBox", null, {
				numberProp1: 1,
				numberProp2: 2,
				booleanProp1: false,
				booleanProp2: true,
				strProp1: "original1",
				strProp2: "original2",
				funcProp: function(){}
			});

			function generateDom(/*String[]*/ nodes, /*Number*/ fan, /*DOMNode*/ parent){
				// summary:
				//		Generate large DOM tree based on nodes in nodes[] array, with fan nodes at each level
				var markup = nodes.shift();
				for(var i=0; i<fan; i++){
					var child = domConstruct.place(markup, parent);
					if(nodes.length){
						generateDom([].concat(nodes), fan, child);	// concat() to clone array
					}
				}
			}

			doh.register("parser performance tests", [
				// Test scan of DOM without any widgets
				{
					name: "scan() with no widgets",
					testType: "perf",
					trialIterations: 20,
					setUp: function(){
						dom.byId("status").innerHTML = "Running scan() with no widgets test...";
						generateDom(["<div></div>", "<div></div>", "<div></div>", "<div></div>", "<scan>hi</scan>"],
								5, "scan");
					},
					tearDown: function(){
						domConstruct.empty("scan");
					},
					runTest: function(){
						parser.parse("scan");
					}
				},

				{
					name: "scan() with lots of widgets",
					testType: "perf",
					trialIterations: 20,
					setUp: function(){
						dom.byId("status").innerHTML = "Running scan() with lots of widgets test...";
						generateDom([
							"<div data-dojo-type=TabContainer></div>",
							"<div data-dojo-type=TabContainer></div>",
							"<div></div>",
							"<input data-dojo-type=TextBox strProp1=name/>"
						], 5, "scan");
					},
					tearDown: function(){
						domConstruct.empty("scan");
					},
					runTest: function(){
						parser.parse("scan");
					}
				},

				{
					name: "scan() with lots of widgets and _stopParser",
					testType: "perf",
					trialIterations: 20,
					setUp: function(){
						dom.byId("status").innerHTML = "Running scan() with lots of widgets and _stopParser test...";
						generateDom([
							"<div data-dojo-type=TabContainer></div>",
							"<div data-dojo-type=ContentPane></div>",
							"<div></div>",
							"<input data-dojo-type=TextBox strProp1=name/>"
						], 5, "scan");
					},
					tearDown: function(){
						domConstruct.empty("scan");
					},
					runTest: function(){
						parser.parse("scan");
					}
				},

				{
					name: "instantiate()",
					testType: "perf",
					trialIterations: 20,
					setUp: function(){
						dom.byId("status").innerHTML = "Running instantiate() test...";
						nodes = [];
						for(var i=0; i<100; i++){
							nodes.push(domConstruct.place("<input data-dojo-type=TextBox numberProp1=1 numberProp2=2 stringProp1=hi booleanProp1=true funcProp='console.log(12345);'/>", "instantiate"));
						}
					},
					tearDown: function(){
						domConstruct.empty("instantiate");
					},
					runTest: function(){
						parser.instantiate(nodes);
					}
				},

				function results(){
					dom.byId("status").innerHTML = "Graphing results...";
				}
			]);

			doh.run();
		});
		</script>
	</head>
	<body>
		<h1>Parser Performance Test</h1>

		<!-- Display progress messages so test doesn't seem hung -->
		<h2 id="status"></h2>

		<!-- Test results are displayed here -->
		<div id="perfTestsBody"></div>

		<!-- for generating markup to scan (no widgets, just nodes) -->
		<div id="scan" style="display: none"></div>

		<!-- for testing widget instantiation speed -->
		<div id="instantiate" style="display: none"></div>
	</body>
</html>
